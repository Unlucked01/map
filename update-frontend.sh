#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ URL API
set -e

echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ API URL..."

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker-compose -f docker-compose.prod.yml down

# –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
echo "üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥..."
docker-compose -f docker-compose.prod.yml build --no-cache frontend

# –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
docker-compose -f docker-compose.prod.yml up -d

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sleep 15

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
echo "üåê –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å..."
HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://unl-map.duckdns.org || echo "000")
HTTPS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://unl-map.duckdns.org || echo "000")

echo "HTTP —Å—Ç–∞—Ç—É—Å: $HTTP_STATUS"
echo "HTTPS —Å—Ç–∞—Ç—É—Å: $HTTPS_STATUS"

if [ "$HTTPS_STATUS" == "200" ]; then
    echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
    echo "üåê –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω: https://unl-map.duckdns.org"
else
    echo "‚ùå –ü—Ä–æ–±–ª–µ–º—ã —Å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é"
    echo "üìã –õ–æ–≥–∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 10 —Å—Ç—Ä–æ–∫:"
    docker-compose -f docker-compose.prod.yml logs --tail=10
fi

echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
docker-compose -f docker-compose.prod.yml ps 